# Руководство для AI-ассистентов

## Описание проекта

Это проект на Go для управления миграциями базы данных PostgreSQL. Проект предоставляет утилиту командной строки `pgm` для создания и выполнения миграций базы данных.

## Структура проекта

Проект следует стандартной структуре Go-проектов:

- `cmd/pgm/` - точка входа приложения, CLI утилита
- `pkg/pgm/` - основная бизнес-логика пакета:
  - `cli/` - обработка команд CLI
  - `db/` - работа с базой данных
  - `fs/` - работа с файловой системой (миграции)
- `sandbox/` - тестовое окружение с примерами
- `scripts/` - вспомогательные скрипты сборки
- `go.mod`, `go.sum` - управление зависимостями

## Технологический стек

- **Язык**: Go 1.25.5+
- **База данных**: PostgreSQL (через pgx/v5)
- **Тестирование**: testify, testcontainers-go
- **Линтинг**: golangci-lint
- **Task runner**: Taskfile (https://taskfile.dev/)

## Соглашения о коде

### Стиль кодирования

- Следуйте стандартному стилю Go (`gofmt`, `goimports`)
- Используйте `golangci-lint` для проверки кода
- Именование: camelCase для локальных переменных, PascalCase для экспортируемых
- Комментарии: документируйте все экспортируемые функции и типы

### Организация кода

- Разделяйте бизнес-логику и CLI-интерфейсы
- Используйте интерфейсы для абстракций
- Обрабатывайте ошибки явно (не игнорируйте)
- Используйте контексты для длительных операций

### Тестирование

- Пишите тесты для всех публичных функций
- Используйте `testcontainers-go` для интеграционных тестов с БД
- Запускайте тесты: `task test`
- Покрытие кода должно быть > 80% для критичных частей

## Команды разработки

### Линтинг
```bash
task lint
```

### Тестирование
```bash
task test
```

### Сборка
```bash
task pgm:build
```

## Работа с базой данных

- Миграции хранятся в директории `sandbox/migrations/`
- Формат файлов: `<timestamp>_<name>.up.sql` и `<timestamp>_<name>.down.sql`
- Таблица миграций отслеживается в схеме `public` (по умолчанию)

## Типичные задачи

### Добавление новой функциональности

1. Создайте feature-ветку от `main`
2. Реализуйте функциональность в соответствующем пакете
3. Добавьте тесты
4. Обновите документацию при необходимости
5. Запустите линтер и тесты
6. Создайте Pull Request

### Исправление багов

1. Воспроизведите проблему с помощью теста
2. Исправьте баг
3. Убедитесь, что тест проходит
4. Запустите все тесты проекта

### Рефакторинг

- Сохраняйте обратную совместимость API
- Обновляйте тесты вместе с кодом
- Проверяйте, что все команды работают после изменений

## Зависимости

- Управление зависимостями через `go.mod`
- Обновление: `go get -u ./...` и `go mod tidy`
- Не коммитьте изменения в `go.sum` без обновления зависимостей

## CI/CD

Проект использует GitLab CI (см. `.gitlab-ci.yml`). Убедитесь, что все проверки проходят локально перед коммитом.

## Полезные ссылки

- [Go Best Practices](https://github.com/golang-standards/project-layout)
- [Effective Go](https://go.dev/doc/effective_go)
- [Taskfile Documentation](https://taskfile.dev/)
